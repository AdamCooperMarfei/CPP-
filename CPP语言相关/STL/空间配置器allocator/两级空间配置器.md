#### 两级空间配置器

1. 第一级配置器直接使用malloc，free和relloc，第二级配置器视情况采用不同的策略：当配置区块超过128bytes时，视之为足够大，便调用第一级配置器；当配置器区块小于128bytes时，为了降低额外负担，使用复杂的内存池整理方式，而不再用一级配置器；
2. 第二级配置器主动将任何小额区块的内存需求量上调至8的倍数，并维护16个free-list，各自管理大小为8～128bytes的小额区块
3. 空间配置函数allocate，首先判断区块大小，大于128就直接调用第一级配置器，小于128时就检查对应的free-list。如果free-list之内有可用区块，就直接拿来用，如果没有可用区块，就将区块大小调整至8的倍数，然后调用refill，为free-list重新分配空间
4. 空间释放函数deallocate，该函数首先判断区块大小，大于128bytes时，直接调用一集配置器，小于128bytes就找到对应的free-list然后释放内存。

#### STL 的两级空间配置器

为什么需要二级空间配置器？

当动态开辟内存时，要在堆上申请，但若是我们需要频繁的在堆上开辟释放内存，就会在**堆上造成很多外部碎片**，浪费内存空间；每次都要进行调用malloc，free函数等操作，使空间就会增加一些附加信息，降低了空间利用率；随着外部碎片增多，内存分配器在找不到合适内存的情况下需要合并空闲块，浪费了时间，大大降低了效率。于是就设置了二级空间适配器，当开辟内存<=128bytes,即视为开辟小块内存，则调用二级空间配置器。

关于stl中一级空间配置器和二级空间配置器的选择上，一般默认选择的为**二级空间配置器**。如果大于128字节再转去一级配置器。

##### 一级配置器

一级空间配置器中重要的函数就是allocate，deallocate，reallocate。一级空间配置器是以malloc，free，realloc等c函数执行实际的内存分配。大致过程是：

1. 直接allocate分配内存，其实就是malloc来分配内存，成功则直接返回，失败就调用处理函数
2. 如果用户自定义了内存分配失败的处理函数就调用，没有的话就返回异常
3. 如果自定义了处理函数就进行处理，完事再继续分配尝试

##### 二级配置器

1. 维护16条链表，分别是0～15号链表，最小8字节，以8字节逐渐递增，最大128字节，当传入一个字节参数，表示需要多大的内存，会自动校对到第几号链表（如需要13bytes空间，我们会给它分配16bytes大小），在找到第你个链表后查看链表是否为空，如果不为空直接从对应的free_list中拨出，将已经拨出的指针向后移动一位
2. 对应的free_list为空，先看其内存池是不是空，如果内存池不为空：（1）先检验其剩余空间是否够20个节点大小（即所需内存大小（提升后）*20），若足够则直接从内存池中拿出20个节点大小空间，将其中一个分配给用户使用，另外19个当作自由链表中的区块挂在相应的free_list下，这样下次再有相同大小的内存需求时，可直接拨出（2）如果不够20个节点大小，则看它是否能满足1个节点大小，如果够的话则直接拿出一个分配给用户，然后从剩余的空间中分配尽可能多的节点挂在相应的free_list（找到相应的free_list）



